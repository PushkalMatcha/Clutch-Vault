// Clutch Vault Database Schema
// PostgreSQL database with Prisma ORM

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model - stores user account information
model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  username  String   @unique
  password  String
  avatar    String?
  isAdmin   Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  registrations Registration[]
  teamsLed      Team[]         @relation("TeamLeader")
  friendships   Friendship[]   @relation("UserFriendships")
  friendOf      Friendship[]   @relation("FriendOf")
  notifications Notification[]
  sentMessages  Message[]      @relation("SentMessages")
  receivedMessages Message[]   @relation("ReceivedMessages")

  @@map("users")
}

// Tournament model - stores tournament information
model Tournament {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  type        String   // 'Squad', 'Solo', 'Duo'
  prize       Int
  startTime   DateTime
  endTime     DateTime?
  maxTeams    Int
  status      String   @default("Open") // 'Open', 'Registering', 'Last Call', 'In Progress', 'Completed'
  imageUrl    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  teams         Team[]
  registrations Registration[]

  @@map("tournaments")
}

// Team model - stores team information
model Team {
  id           Int      @id @default(autoincrement())
  name         String
  tournamentId Int
  leaderId     Int
  roomCode     String?
  teammates    Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  tournament    Tournament     @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  leader        User           @relation("TeamLeader", fields: [leaderId], references: [id])
  registrations Registration[]

  @@map("teams")
}

// Registration model - links users to tournaments
model Registration {
  id           Int      @id @default(autoincrement())
  userId       Int
  tournamentId Int
  teamId       Int?
  role         String   // 'Team Leader', 'Team Member', 'Solo'
  status       String   @default("Registered") // 'Registered', 'Confirmed', 'Cancelled'
  placement    Int?     // 1 for 1st, 2 for 2nd, etc.
  earnings     Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  tournament Tournament @relation(fields: [tournamentId], references: [id], onDelete: Cascade)
  team       Team?      @relation(fields: [teamId], references: [id], onDelete: SetNull)

  @@unique([userId, tournamentId])
  @@map("registrations")
}

// Friendship model - manages friend relationships
model Friendship {
  id        Int      @id @default(autoincrement())
  userId    Int
  friendId  Int
  status    String   @default("pending") // 'pending', 'accepted', 'rejected'
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user   User @relation("UserFriendships", fields: [userId], references: [id], onDelete: Cascade)
  friend User @relation("FriendOf", fields: [friendId], references: [id], onDelete: Cascade)

  @@unique([userId, friendId])
  @@map("friendships")
}

// Notification model - stores user notifications
model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  title     String
  content   String
  type      String   @default("general") // 'general', 'friend_request', 'tournament', 'system'
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

// Message model - stores direct messages between users
model Message {
  id         Int      @id @default(autoincrement())
  senderId   Int
  receiverId Int
  content    String
  read       Boolean  @default(false)
  createdAt  DateTime @default(now())

  // Relations
  sender   User @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  @@map("messages")
}
